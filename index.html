<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°å°ç•«æ›†å¸«ï¼šå¸ƒè¾²æ¿æ›†å‰µä½œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <!-- åŠ å…¥ html2canvas ä»¥æ”¯æ´åœ–ç‰‡ä¸‹è¼‰ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Helper to ensure consistent App ID across the entire app
        const getSanitizedAppId = () => {
            const raw = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            return raw.replace(/\//g, '_');
        };

        window.firebaseModules = { 
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, 
            getFirestore, doc, setDoc, collection, onSnapshot, serverTimestamp,
            APP_ID: getSanitizedAppId()
        };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f5efe6;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d4c5b0' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            overscroll-behavior: none;
        }
        
        .wood-texture {
            background-color: #8b5e3c;
            background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(0,0,0,0.05) 10px, rgba(0,0,0,0.05) 20px);
            box-shadow: inset 0 0 30px rgba(0,0,0,0.6);
            border: 8px solid #5d4037;
            border-radius: 1rem;
        }

        .canvas-container {
            touch-action: none; 
            cursor: crosshair;
        }
        
        .bunun-pattern {
            background: repeating-linear-gradient(
                90deg,
                #1a1a1a 0px, #1a1a1a 10px,
                #ffffff 10px, #ffffff 14px,
                #b91c1c 14px, #b91c1c 24px,
                #ffffff 24px, #ffffff 28px
            );
            height: 24px;
            width: 100%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: #8d6e63; 
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        const STUDENT_LIST = [
            "01 è˜‡è›æ™", "02 é¾”å®¸å®", "03 åŠ‰å®—æº", "04 é‚±å®‡ç¿”", "05 å‘¨ç‚³ç››",
            "06 æœ±ä¸å‡±", "07 é™³å®¥å®‰", "08 åŠ‰å­è³“", "09 æ¥Šæ™Ÿå®", "10 é™³å®¥å‡±",
            "11 è˜‡å‡¡éˆ", "12 å‘¨éƒç¿”", "13 é¦®å£«ç‘œ", "14 é™³ç¾©å‡±", "15 æ—å®¶ç”°",
            "16 æ±Ÿå®¥è‘³", "17 æ±Ÿå®¥è±", "18 éº¥èŠ·ç‘„", "19 æ—é›¨æ™´", "20 å¼µå¿ƒç‘œ",
            "21 æ—å§¿å‡", "22 é¾å…è“", "23 æå“å¦¡", "24 é»ƒè‹¥ç‘œ", "25 ç°¡å­åª›",
            "26 æ—æ°¸æ™´", "27 éƒ­å“å²‘", "åº­å®‰è€å¸«"
        ];

        // --- Icons ---
        const Icon = ({ size = 24, color = "currentColor", children, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                {children}
            </svg>
        );

        const Pencil = (props) => <Icon {...props}><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z" /><path d="m15 5 4 4" /></Icon>;
        const Eraser = (props) => <Icon {...props}><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21" /><path d="M22 21H7" /><path d="m5 11 9 9" /></Icon>;
        const RotateCcw = (props) => <Icon {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /></Icon>;
        const Save = (props) => <Icon {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></Icon>;
        const Info = (props) => <Icon {...props}><circle cx="12" cy="12" r="10" /><path d="M12 16v-4" /><path d="M12 8h.01" /></Icon>;
        const X = (props) => <Icon {...props}><path d="M18 6 6 18" /><path d="m6 6 12 12" /></Icon>;
        const CloudUpload = (props) => <Icon {...props}><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></Icon>;
        const CheckCircle = (props) => <Icon {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></Icon>;
        const Lock = (props) => <Icon {...props}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></Icon>;
        const User = (props) => <Icon {...props}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></Icon>;
        const RefreshCw = (props) => <Icon {...props}><path d="M21 2v6h-6"></path><path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path><path d="M3 22v-6h6"></path><path d="M21 12a9 9 0 0 1-15 6.7L3 16"></path></Icon>;
        const AlertTriangle = (props) => <Icon {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" /><line x1="12" y1="9" x2="12" y2="13" /><line x1="12" y1="17" x2="12.01" y2="17" /></Icon>;
        const ImageDown = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></Icon>;

        // --- Custom Bunum Symbol SVGs ---
        const SymbolIcon = ({ type, size = 40 }) => {
            const commonProps = { width: size, height: size, viewBox: "0 0 40 40", fill: "none", stroke: "#5d4037", strokeWidth: "3", strokeLinecap: "round", strokeLinejoin: "round" };
            switch(type) {
                case 'day': return <svg {...commonProps} fill="#5d4037"><path d="M20 5 L35 35 H5 Z" /></svg>; 
                case 'boil': return <svg {...commonProps}><path d="M5 25 A15 15 0 0 1 35 25" /><line x1="5" y1="25" x2="35" y2="25" /><line x1="20" y1="25" x2="20" y2="35" /></svg>;
                case 'prohibit': return <svg {...commonProps}><rect x="5" y="10" width="30" height="20" /></svg>;
                case 'taro': return <svg {...commonProps}><circle cx="12" cy="12" r="4" /><circle cx="28" cy="12" r="4" /><circle cx="12" cy="28" r="4" /><circle cx="12" cy="28" r="4" /></svg>;
                case 'hunt': return <svg {...commonProps}><path d="M5 35 L20 10 L35 35" /></svg>;
                case 'hoe': return <svg {...commonProps}><path d="M25 5 H10 V25" strokeWidth="4"/></svg>;
                case 'clearing': return <svg {...commonProps}><rect x="8" y="8" width="24" height="24" /><circle cx="15" cy="15" r="1" fill="currentColor"/><circle cx="25" cy="15" r="1" fill="currentColor"/><circle cx="15" cy="25" r="1" fill="currentColor"/><circle cx="25" cy="25" r="1" fill="currentColor"/></svg>;
                case 'count': return <svg {...commonProps}><circle cx="20" cy="20" r="12" /><path d="M20 20 L20 8" /><path d="M20 20 L28 12" /><path d="M20 20 L32 20" /><path d="M20 20 L12 28" /><path d="M20 20 L8 20" /></svg>;
                case 'pig': return <svg {...commonProps}><path d="M10 25c0-5 3-10 10-10 8 0 12 5 12 10H10z" /><circle cx="15" cy="20" r="1.5" fill="currentColor"/></svg>;
                case 'rifle': return <svg {...commonProps}><path d="M5 30 L15 30 L15 15 L35 5" /></svg>;
                case 'field': return <svg {...commonProps}><rect x="5" y="10" width="30" height="20" /><line x1="15" y1="10" x2="15" y2="30" /><line x1="25" y1="10" x2="25" y2="30" /></svg>;
                case 'tree': return <svg {...commonProps}><path d="M20 35 V5" /><path d="M20 25 L10 15" /><path d="M20 20 L30 10" /><path d="M20 15 L15 10" /><path d="M20 10 L25 5" /></svg>;
                default: return null;
            }
        };

        const BUNUN_SYMBOLS = [
            { name: "åˆ»ç—• (ä¸€æ—¥)", meaning: "ä¸‰è§’å½¢åˆ»ç—•ï¼Œä»£è¡¨éå»äº†ä¸€å¤©ã€‚", type: "day" },
            { name: "é–‹å¢¾ (é‹¤é ­)", meaning: "é‹¤é ­å½¢ç‹€ï¼Œè¡¨ç¤ºé–‹å§‹æ•´åœ°ã€è€•ä½œã€‚", type: "hoe" },
            { name: "ç…®æ —", meaning: "åŠåœ“å½¢ä»£è¡¨å¹³åº•é‹ï¼Œæ­£åœ¨ç…®æ —ç±³é‡€é…’ã€‚", type: "boil" },
            { name: "ç¥­ç¥€ (è±¬)", meaning: "ç•«å‡ºè±¬çš„å½¢ç‹€ï¼Œè¡¨ç¤ºæ®ºè±¬ç¥­ç¥€ã€‚", type: "pig" },
            { name: "å‡ºçµ", meaning: "å±±å³°çš„å½¢ç‹€ï¼Œè¡¨ç¤ºä¸Šå±±æ‰“çµã€‚", type: "hunt" },
            { name: "æ”¾ç½®èŠ‹é ­", meaning: "å››å€‹åœ“åœˆï¼Œè¡¨ç¤ºæŠŠèŠ‹é ­æ”¾åœ¨å¹³ç± ä¸­ã€‚", type: "taro" },
            { name: "æ•¸æ —", meaning: "åœ“å½¢å…§æœ‰æ”¾å°„ç·šï¼Œè¡¨ç¤ºæ¸…é»æ”¶æˆã€‚", type: "count" },
            { name: "ç¦æ­¢æŸ´è–ª", meaning: "é•·æ–¹å½¢ï¼Œè¡¨ç¤ºæ­¤æ—¥ä¸å¯ç æŸ´ã€‚", type: "prohibit" },
            { name: "ç”°åœ’", meaning: "æœ‰æ ¼å­çš„é•·æ–¹å½¢ï¼Œä»£è¡¨ç”°åœ°ã€‚", type: "field" },
            { name: "çµé¹¿è€³", meaning: "çµæ§å½¢ç‹€ï¼Œè¡¨ç¤ºå°„çµé¹¿çš„è€³æœµã€‚", type: "rifle" },
            { name: "é–‹å¢¾åœ’åœ°", meaning: "æ–¹æ¡†å…§æœ‰é»ï¼Œè¡¨ç¤ºé–‹å¢¾æ–°çš„ç”°åœ°ã€‚", type: "clearing" },
            { name: "æ¦›æ¨¹", meaning: "æ¨¹æå½¢ç‹€ï¼Œè¡¨ç¤ºèˆ‡æ¤ç‰©ç›¸é—œçš„æ´»å‹•ã€‚", type: "tree" },
        ];

        const ANCESTRAL_SEQUENCE = [
            { days: 3, event: "é–‹å¢¾ç¥­", icons: ['hoe', 'clearing'] },
            { days: 4, event: "æ’­æ —ç¥­", icons: ['count', 'hunt', 'hoe'] },
            { days: 3, event: "æ —æ”¶ç©«ç¥­", icons: ['prohibit', 'count'] },
            { days: 3, event: "é™¤è‰ç¥­", icons: ['hoe', 'tree', 'tree'] },
            { days: 4, event: "æ‰“è€³ç¥­", icons: ['prohibit', 'hunt', 'rifle'] },
            { days: 4, event: "è±æ”¶ç¥­", icons: ['pig', 'pig', 'taro'] },
            { days: 3, event: "é¦–é£¾ç¥­", icons: ['taro', 'taro', 'taro'] },
            { days: 3, event: "å–ç©—ç¥­", icons: ['tree', 'hunt'] },
        ];

        // --- Components ---
        const AncestralBoard = () => {
            return (
                <div className="bg-white rounded-3xl shadow-xl border-4 border-[#5d4037] mb-8 overflow-hidden">
                    <div className="bg-[#f5efe6] p-4 flex justify-between items-center border-b border-[#d7ccc8]">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-[#5d4037] rounded-full flex items-center justify-center text-white"><Icon size={24}><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></Icon></div>
                            <div><h3 className="text-xl font-black text-[#5d4037]">ç¥–å…ˆçš„æ™ºæ…§ï¼šåŸå§‹ç•«æ›†</h3><p className="text-xs text-[#8d6e63]">å‘å³æ»‘å‹•ï¼Œçœ‹çœ‹ä»¥å‰çš„äººæ€éº¼ç•«</p></div>
                        </div>
                    </div>
                    <div className="p-4 md:p-6 bg-[#fffbf5] relative">
                         <div className="absolute top-0 left-0 w-4 h-full bg-gradient-to-r from-[#fffbf5] to-transparent z-10 pointer-events-none"></div>
                         <div className="absolute top-0 right-0 w-4 h-full bg-gradient-to-l from-[#fffbf5] to-transparent z-10 pointer-events-none"></div>
                        <div className="overflow-x-auto overflow-y-hidden custom-scrollbar pb-14" style={{ touchAction: 'pan-x' }}>
                            <div className="flex items-end min-w-max px-4 pt-8">
                                {ANCESTRAL_SEQUENCE.map((period, pIdx) => (
                                    <div key={pIdx} className="flex flex-col items-start relative mr-1">
                                        <div className="absolute -bottom-10 left-0 w-full text-center text-xs md:text-sm font-bold text-[#5d4037] border-t border-[#d7ccc8] pt-1 mt-2 whitespace-nowrap">{period.event}</div>
                                        <div className="flex">
                                            {Array.from({ length: period.days }).map((_, dIdx) => {
                                                const iconType = period.icons[dIdx] || null;
                                                return (
                                                    <div key={dIdx} className="flex flex-col items-center justify-end w-10 md:w-14">
                                                        <div className="h-16 flex items-end mb-1">{iconType && <SymbolIcon type={iconType} size={32} />}</div>
                                                        <div className="w-4 h-4 md:w-5 md:h-5 bg-black transform rotate-45 mb-2"></div>
                                                        <div className="w-full h-1 bg-black absolute bottom-4 left-0 right-0 -z-10"></div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                        <div className="w-[1px] h-12 bg-gray-400 absolute bottom-0 right-0 translate-x-1/2"></div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const DrawingCanvas = ({ currentDay, onClose, onSave, existingImage, existingDesc }) => {
            const canvasRef = useRef(null);
            const [isDrawing, setIsDrawing] = useState(false);
            const [tool, setTool] = useState('pencil'); 
            const [description, setDescription] = useState(existingDesc || '');
            
            useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                const dpr = window.devicePixelRatio || 1;
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width * dpr;
                canvas.height = rect.height * dpr;
                ctx.fillStyle = '#e8dcc5';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                if (existingImage) {
                    const img = new Image();
                    img.onload = () => ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    img.src = existingImage;
                }
            }, []);

            const getPos = (e) => {
                const canvas = canvasRef.current;
                const rect = canvas.getBoundingClientRect();
                const clientX = e.clientX || (e.touches && e.touches[0] ? e.touches[0].clientX : 0);
                const clientY = e.clientY || (e.touches && e.touches[0] ? e.touches[0].clientY : 0);
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                return { x: (clientX - rect.left) * scaleX, y: (clientY - rect.top) * scaleY };
            };

            const startDrawing = (e) => {
                const { x, y } = getPos(e);
                const ctx = canvasRef.current.getContext('2d');
                ctx.beginPath();
                ctx.moveTo(x, y);
                setIsDrawing(true);
            };

            const draw = (e) => {
                if (!isDrawing) return;
                const { x, y } = getPos(e);
                const ctx = canvasRef.current.getContext('2d');
                const dpr = window.devicePixelRatio || 1;
                const baseLineWidth = tool === 'eraser' ? 20 : 6;
                ctx.lineWidth = baseLineWidth * dpr;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.strokeStyle = tool === 'eraser' ? '#e8dcc5' : '#4a3728';
                ctx.lineTo(x, y);
                ctx.stroke();
            };

            const stopDrawing = () => setIsDrawing(false);

            const handleSave = () => {
                const canvas = canvasRef.current;
                onSave(currentDay.id, canvas.toDataURL(), description);
                onClose();
            };

            const clearCanvas = () => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#e8dcc5';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-2 md:p-4">
                    <div className="bg-[#fdfbf7] rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[95vh] border-4 border-[#5d4037]">
                        <div className="bg-[#5d4037] p-5 flex justify-between items-center text-white relative overflow-hidden shrink-0">
                             <div className="absolute top-0 left-0 w-full h-4 bg-red-700 opacity-50"></div>
                            <h3 className="text-2xl md:text-3xl font-bold pl-2 relative z-10">åˆ»ç•«ï¼š{currentDay.label}</h3>
                            <button onClick={onClose} className="bg-[#3e2723] hover:bg-red-800 p-2 rounded-full transition relative z-10"><X size={32} /></button>
                        </div>
                        <div className="flex-1 overflow-y-auto overflow-x-hidden custom-scrollbar relative bg-white">
                            <div className="p-3 md:p-4 bg-gray-100 flex flex-col items-center justify-center">
                                <p className="text-[#5d4037] mb-2 font-bold text-sm md:text-base flex items-center gap-2">
                                    <span className="bg-[#8b5e3c] text-white px-2 py-1 rounded text-xs">æç¤º</span> åœ¨æœ¨æ¿ä¸Šç•«å‡ºä¸€å€‹ç¬¦è™Ÿä»£è¡¨ä»Šå¤©
                                </p>
                                <div className="relative w-full h-[300px] md:h-[350px] shadow-inner border-[6px] border-[#a1887f] rounded-lg bg-[#e8dcc5] overflow-hidden cursor-crosshair shrink-0">
                                    <canvas ref={canvasRef} className="w-full h-full canvas-container touch-none" onMouseDown={startDrawing} onMouseMove={draw} onMouseUp={() => setIsDrawing(false)} onMouseLeave={() => setIsDrawing(false)} onTouchStart={startDrawing} onTouchMove={draw} onTouchEnd={() => setIsDrawing(false)} />
                                </div>
                            </div>
                            <div className="p-3 md:p-4 space-y-4 pb-8">
                                <div className="flex justify-center gap-6">
                                    <button onClick={() => setTool('pencil')} className={`p-4 rounded-xl flex flex-col items-center transition w-24 ${tool === 'pencil' ? 'bg-[#5d4037] text-white shadow-lg scale-105' : 'bg-gray-100 text-gray-600 border'}`}><Pencil size={28} /><span className="text-sm font-bold mt-1">åˆ»åˆ€</span></button>
                                    <button onClick={() => setTool('eraser')} className={`p-4 rounded-xl flex flex-col items-center transition w-24 ${tool === 'eraser' ? 'bg-[#5d4037] text-white shadow-lg scale-105' : 'bg-gray-100 text-gray-600 border'}`}><Eraser size={28} /><span className="text-sm font-bold mt-1">ç£¨å¹³</span></button>
                                    <button onClick={clearCanvas} className="p-4 rounded-xl flex flex-col items-center bg-white text-red-600 border-2 border-red-100 hover:bg-red-50 w-24"><RotateCcw size={28} /><span className="text-sm font-bold mt-1">é‡æ‹¿ä¸€å¡Š</span></button>
                                </div>
                                <div className="bg-yellow-50 p-4 rounded-xl border border-yellow-200">
                                    <label className="block text-base md:text-lg font-bold text-[#5d4037] mb-2 flex items-center gap-2"><span className="w-2 h-8 bg-[#b91c1c] rounded-full inline-block"></span> ç‚ºæ‰€ç•«ä¹‹äº‹å‘½åï¼š</label>
                                    <input type="text" value={description} onChange={(e) => setDescription(e.target.value)} placeholder="ä¾‹å¦‚ï¼šç·´ç¿’å¤§éšŠæ¥åŠ›ã€å¹«å¿™åšå®¶äº‹..." className="w-full p-4 text-lg border-2 border-[#d7ccc8] rounded-xl focus:ring-4 focus:ring-[#8b5e3c] focus:border-[#5d4037] outline-none" />
                                </div>
                            </div>
                        </div>
                        <div className="p-3 border-t bg-[#f5efe6] flex justify-between items-center shrink-0">
                            <button onClick={onClose} className="px-6 py-3 text-gray-600 font-bold text-lg hover:bg-gray-200 rounded-xl">å–æ¶ˆ</button>
                            <button onClick={handleSave} className="px-8 py-3 bg-[#b91c1c] text-white rounded-xl hover:bg-[#991b1b] flex items-center gap-3 font-bold text-lg shadow-lg transform active:scale-95 transition"><Save size={24} /> å®Œæˆåˆ»ç•«</button>
                        </div>
                    </div>
                </div>
            );
        };

        // Teacher Dashboard
        const StudentModal = ({ student, onClose }) => {
            if (!student) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}>
                        <div className="bg-[#5d4037] p-4 flex justify-between items-center text-white">
                            <div className="flex items-center gap-3">
                                <div className="bg-white/20 p-2 rounded-full"><User size={20}/></div>
                                <div><h2 className="text-2xl font-bold">{student.studentName} çš„ç•«æ›†</h2><p className="text-sm text-white/80">å®Œæˆåº¦: {student.completionCount}/5 å¤©</p></div>
                            </div>
                            <button onClick={onClose} className="hover:bg-white/20 p-2 rounded-full"><X size={24} /></button>
                        </div>
                        <div className="p-6 overflow-y-auto bg-[#f5efe6]">
                            <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
                                {student.days.map((day) => (
                                    <div key={day.id} className="bg-white p-3 rounded-lg shadow border border-[#d7ccc8] flex flex-col">
                                        <div className="bg-[#5d4037] text-white text-center py-1 rounded-t font-bold mb-2">{day.label}</div>
                                        <div className="aspect-[3/4] bg-[#e8dcc5] rounded border-2 border-[#d7ccc8] mb-2 flex items-center justify-center overflow-hidden">
                                            {day.image ? <img src={day.image} alt={day.label} className="w-full h-full object-contain" /> : <span className="text-gray-400 text-sm">æœªåˆ»ç•«</span>}
                                        </div>
                                        <div className="bg-gray-50 p-2 rounded text-sm text-[#5d4037] min-h-[3rem] font-medium border border-gray-100">{day.desc || "--"}</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const TeacherDashboard = ({ onBack, db, user, appId }) => {
            const [students, setStudents] = useState([]);
            const [selectedStudent, setSelectedStudent] = useState(null);
            const [loading, setLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState('');
            const [error, setError] = useState('');

            const fetchStudents = () => {
                setLoading(true);
                setError('');
                if (!user || !db) {
                     setError("é€£ç·šæœªå°±ç·’ï¼Œè«‹ç¨å¾Œå†è©¦");
                     setLoading(false);
                     return;
                }

                const { collection, onSnapshot } = window.firebaseModules;
                const submissionsRef = collection(db, 'artifacts', appId, 'public', 'data', 'submissions');

                const timer = setTimeout(() => {
                    try {
                        const unsubscribe = onSnapshot(submissionsRef, (snapshot) => {
                            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            data.sort((a, b) => {
                                 const timeB = (b.updatedAt && b.updatedAt.seconds) ? b.updatedAt.seconds : 0;
                                 const timeA = (a.updatedAt && a.updatedAt.seconds) ? a.updatedAt.seconds : 0;
                                 return timeB - timeA;
                            });
                            setStudents(data);
                            setLoading(false);
                        }, (err) => {
                            console.error("Snapshot Error:", err);
                            setError("è®€å–å¤±æ•—: " + err.message);
                            setLoading(false);
                        });
                        return unsubscribe;
                    } catch (e) {
                         console.error("Setup Error:", e);
                         setError("åˆå§‹åŒ–å¤±æ•—");
                         setLoading(false);
                    }
                }, 500);
                return () => clearTimeout(timer);
            };

            useEffect(() => {
                const unsubscribe = fetchStudents();
                return () => { if(unsubscribe && typeof unsubscribe === 'function') unsubscribe(); };
            }, [user, db, appId]);

            const filteredStudents = students.filter(s => s.studentName && s.studentName.toLowerCase().includes(searchTerm.toLowerCase()));
            const total = students.length;
            const completed = students.filter(s => s.completionCount === 5).length;
            const rate = total > 0 ? Math.round((completed / total) * 100) : 0;

            return (
                <div className="min-h-screen bg-gray-100">
                    <nav className="bg-[#3e2723] text-white shadow-lg sticky top-0 z-20">
                        <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <button onClick={onBack} className="bg-white/10 p-2 rounded hover:bg-white/20"><RotateCcw size={20} /></button>
                                <h1 className="text-xl font-bold">æ•™å¸«ç®¡ç†å¾Œå°</h1>
                            </div>
                            <div className="flex gap-2 items-center">
                                <div className="text-sm opacity-80 mr-2">å³æ™‚æ›´æ–°</div>
                                <button onClick={fetchStudents} className="text-xs bg-white/20 px-3 py-1 rounded hover:bg-white/30 flex items-center gap-1"><RefreshCw size={14}/> è¼‰å…¥è³‡æ–™</button>
                            </div>
                        </div>
                    </nav>
                    <main className="max-w-7xl mx-auto px-4 py-8">
                        {error && <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4 font-bold flex justify-between items-center"><span>{error}</span> <button onClick={fetchStudents} className="text-sm underline">é‡è©¦</button></div>}
                        
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div className="bg-white p-6 rounded-xl shadow border-l-4 border-blue-500">
                                <h3 className="text-gray-500 text-sm font-bold uppercase">å·²ç¹³äº¤äººæ•¸</h3>
                                <p className="text-4xl font-bold text-gray-800 mt-2">{total} <span className="text-lg font-normal text-gray-400">ä½</span></p>
                            </div>
                            <div className="bg-white p-6 rounded-xl shadow border-l-4 border-green-500">
                                <h3 className="text-gray-500 text-sm font-bold uppercase">å…¨éƒ¨å®Œæˆ (5å¤©)</h3>
                                <p className="text-4xl font-bold text-green-600 mt-2">{completed} <span className="text-lg font-normal text-gray-400">ä½</span></p>
                            </div>
                            <div className="bg-white p-6 rounded-xl shadow border-l-4 border-yellow-500">
                                <h3 className="text-gray-500 text-sm font-bold uppercase">ç­ç´šå®Œæˆç‡</h3>
                                <p className="text-4xl font-bold text-yellow-600 mt-2">{rate}%</p>
                            </div>
                        </div>
                        <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                            <div className="p-4 border-b border-gray-200 bg-gray-50 flex flex-col md:flex-row justify-between items-center gap-4">
                                <h2 className="text-lg font-bold text-gray-700 flex items-center gap-2"><User size={20}/> å­¸ç”Ÿåˆ—è¡¨</h2>
                                <input type="text" placeholder="æœå°‹å§“å..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="pl-4 pr-4 py-2 border border-gray-300 rounded-lg w-full md:w-64 focus:outline-none focus:ring-2 focus:ring-[#5d4037]" />
                            </div>
                            {loading ? <div className="p-12 text-center text-gray-500">è¼‰å…¥ä¸­...</div> : filteredStudents.length === 0 ? <div className="p-12 text-center text-gray-500">æš«ç„¡è³‡æ–™</div> : (
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left border-collapse">
                                        <thead>
                                            <tr className="bg-gray-50 text-gray-600 text-sm uppercase">
                                                <th className="p-4 font-bold border-b">å§“å</th>
                                                <th className="p-4 font-bold border-b text-center">å®Œæˆé€²åº¦</th>
                                                <th className="p-4 font-bold border-b text-right">æ“ä½œ</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-100">
                                            {filteredStudents.map(s => (
                                                <tr key={s.id} className="hover:bg-gray-50">
                                                    <td className="p-4 font-bold text-gray-800">{s.studentName}</td>
                                                    <td className="p-4 text-center">
                                                        <span className={`px-3 py-1 rounded-full text-xs font-bold ${s.completionCount === 5 ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`}>{s.completionCount} / 5</span>
                                                    </td>
                                                    <td className="p-4 text-right"><button onClick={() => setSelectedStudent(s)} className="bg-[#5d4037] text-white px-4 py-2 rounded hover:bg-[#3e2723] text-sm font-bold shadow">æŸ¥çœ‹</button></td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>
                    </main>
                    <StudentModal student={selectedStudent} onClose={() => setSelectedStudent(null)} />
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const STORAGE_KEY = 'bunun_calendar_v3_local'; 
            const [days, setDays] = useState(() => {
                const saved = localStorage.getItem(STORAGE_KEY);
                return saved ? JSON.parse(saved) : [
                    { id: 'mon', label: 'é€±ä¸€', image: null, desc: '' },
                    { id: 'tue', label: 'é€±äºŒ', image: null, desc: '' },
                    { id: 'wed', label: 'é€±ä¸‰', image: null, desc: '' },
                    { id: 'thu', label: 'é€±å››', image: null, desc: '' },
                    { id: 'fri', label: 'é€±äº”', image: null, desc: '' },
                ];
            });
            const [studentName, setStudentName] = useState(localStorage.getItem('student_name') || '');
            const [activeDay, setActiveDay] = useState(null);
            const [showReference, setShowReference] = useState(false);
            const [user, setUser] = useState(null);
            const [dbInstance, setDbInstance] = useState(null);
            const [isUploading, setIsUploading] = useState(false);
            const [uploadSuccess, setUploadSuccess] = useState(false);
            const [mode, setMode] = useState('student'); 
            const [showLogin, setShowLogin] = useState(false);
            const [password, setPassword] = useState('');
            const [showExport, setShowExport] = useState(false); // Added state for export modal

            useEffect(() => {
                const initAuth = async () => {
                    if (window.firebaseModules) {
                        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore } = window.firebaseModules;
                        const firebaseConfig = JSON.parse(__firebase_config);
                        const app = initializeApp(firebaseConfig);
                        const auth = getAuth(app);
                        const db = getFirestore(app);
                        setDbInstance(db);
                        
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                             await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                        onAuthStateChanged(auth, (u) => setUser(u));
                    }
                };
                initAuth();
            }, []);

            useEffect(() => { localStorage.setItem(STORAGE_KEY, JSON.stringify(days)); }, [days]);
            useEffect(() => { localStorage.setItem('student_name', studentName); }, [studentName]);

            const handleSaveDay = (id, img, desc) => {
                setDays(days.map(d => d.id === id ? { ...d, image: img, desc: desc } : d));
            };

            const resetAll = () => {
                if(confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰ç•«æ›†é‡æ–°é–‹å§‹å—ï¼Ÿ')) setDays(days.map(d => ({ ...d, image: null, desc: '' })));
            };

            const uploadWork = async () => {
                if (!studentName) return alert("è«‹å…ˆé¸æ“‡ä½ çš„å§“åå–”ï¼");
                if (!user || !dbInstance) return alert("æ­£åœ¨é€£æ¥é›²ç«¯ï¼Œè«‹ç¨å¾Œ...");
                
                const { doc, setDoc, serverTimestamp, APP_ID } = window.firebaseModules;
                
                setIsUploading(true);
                try {
                    const docRef = doc(dbInstance, 'artifacts', APP_ID, 'public', 'data', 'submissions', user.uid);
                    await setDoc(docRef, { studentName, days, updatedAt: serverTimestamp(), completionCount: days.filter(d => d.image).length });
                    setIsUploading(false);
                    setUploadSuccess(true);
                    setTimeout(() => setUploadSuccess(false), 3000);
                } catch (e) {
                    console.error(e);
                    setIsUploading(false);
                    alert("ä¸Šå‚³å¤±æ•—: " + e.message);
                }
            };

            const handleTeacherLogin = () => {
                if (password === '1234') {
                    setMode('teacher');
                    setShowLogin(false);
                    setPassword('');
                } else {
                    alert('å¯†ç¢¼éŒ¯èª¤');
                }
            };

            if (mode === 'teacher') {
                // Use the centralized APP_ID from modules
                const globalAppId = window.firebaseModules.APP_ID;
                return <TeacherDashboard onBack={() => setMode('student')} db={dbInstance} user={user} appId={globalAppId} />;
            }

            return (
                <div className="min-h-screen pb-20 bg-[#f5efe6] select-none">
                    {/* Header */}
                    <header className="bg-[#3e2723] text-[#f5efe6] shadow-xl relative overflow-hidden">
                        <div className="bunun-pattern"></div>
                        <div className="max-w-7xl mx-auto px-4 py-6 md:py-8 relative z-10">
                            <div className="flex flex-col lg:flex-row justify-between items-center gap-4">
                                <div className="text-center lg:text-left">
                                    <h1 className="text-3xl md:text-5xl font-black tracking-wider mb-2 flex items-center justify-center lg:justify-start gap-4 text-[#f5efe6]">
                                        <Icon size={48} className="text-[#b91c1c]"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" /><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" /></Icon>
                                        å°å°ç•«æ›†å¸«
                                    </h1>
                                    <p className="text-[#d7ccc8] text-lg font-medium">è¨˜éŒ„ä½ çš„æ¯é€±å¤§äº‹ Â· å‚³æ‰¿å¸ƒè¾²æ¿æ›†æ™ºæ…§</p>
                                </div>
                                <div className="bg-[#5d4037] p-3 rounded-xl flex flex-col md:flex-row items-center gap-3 border border-[#8d6e63] shadow-lg">
                                    <div className="flex items-center gap-2">
                                        <label className="font-bold text-[#d7ccc8] whitespace-nowrap">æˆ‘æ˜¯ï¼š</label>
                                        <select value={studentName} onChange={(e) => setStudentName(e.target.value)} className="bg-[#3e2723] text-white border border-[#8d6e63] rounded px-3 py-2 w-40 text-center cursor-pointer appearance-none">
                                            <option value="" disabled>è«‹é¸æ“‡å§“å</option>
                                            {STUDENT_LIST.map(n => <option key={n} value={n}>{n}</option>)}
                                        </select>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={uploadWork} disabled={isUploading} className={`flex items-center gap-2 px-4 py-2 rounded-lg font-bold transition shadow-md whitespace-nowrap ${uploadSuccess ? 'bg-green-600 text-white' : 'bg-[#b91c1c] text-white hover:bg-[#991b1b]'} ${isUploading ? 'opacity-50' : ''}`}>
                                            {isUploading ? <span>ä¸Šå‚³ä¸­...</span> : uploadSuccess ? <React.Fragment><CheckCircle size={20}/> ä¸Šå‚³æˆåŠŸ</React.Fragment> : <React.Fragment><CloudUpload size={20}/> ä¸Šå‚³ä½œæ¥­</React.Fragment>}
                                        </button>
                                        <button onClick={() => setShowExport(true)} className="flex items-center gap-2 px-4 py-2 rounded-lg font-bold transition shadow-md whitespace-nowrap bg-yellow-600 text-white hover:bg-yellow-700">
                                            <React.Fragment><ImageDown size={20}/> å­˜æˆåœ–ç‰‡</React.Fragment>
                                        </button>
                                    </div>
                                </div>
                                <div className="flex gap-3">
                                    <button onClick={() => setShowReference(true)} className="bg-[#f5efe6] text-[#5d4037] px-4 py-3 rounded-full font-bold text-lg flex items-center gap-2 shadow-lg hover:bg-white transition active:scale-95">
                                        <Info size={24} /><span className="hidden md:inline">ç¬¦è™Ÿåœ–é‘‘</span>
                                    </button>
                                    <button onClick={resetAll} className="bg-[#5d4037] border border-[#8d6e63] text-white px-4 py-3 rounded-full font-bold flex items-center gap-2 hover:bg-[#4e342e]">
                                        <RotateCcw size={20} />
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 py-8">
                        <AncestralBoard />
                        <div className="bg-white p-6 md:p-8 rounded-3xl shadow-lg mb-8 border-l-8 border-[#b91c1c] relative overflow-hidden">
                            <div className="absolute right-0 top-0 opacity-10 transform translate-x-1/4 -translate-y-1/4">
                                <svg width="200" height="200" viewBox="0 0 100 100" fill="#5d4037"><path d="M50 0 L100 100 H0 Z" /></svg>
                            </div>
                            <h2 className="text-2xl font-bold text-[#5d4037] mb-3">ğŸ‘‹ å—¨ï¼å°å°ç•«æ›†å¸«</h2>
                            <p className="text-gray-700 text-lg leading-relaxed">
                                ä¸Šé¢æ˜¯å¸ƒè¾²æ—ç¥–å…ˆçš„ç•«æ›†ã€‚ç¾åœ¨æ›ä½ ä¾†æŒ‘æˆ°ï¼Œå¹«è‡ªå·±è¦åŠƒä¸‹é€±çš„ç”Ÿæ´»ã€‚å®Œæˆå¾Œè¨˜å¾—é»å³ä¸Šè§’çš„<b>ã€Œä¸Šå‚³ä½œæ¥­ã€</b>å–”ï¼
                            </p>
                        </div>
                        <div className="relative">
                            <div className="wood-texture p-6 md:p-10 relative mb-12 shadow-2xl flex justify-center">
                                {[...Array(4)].map((_, i) => <div key={i} className={`absolute w-6 h-6 rounded-full bg-[#271c19] shadow-inner border border-[#4e342e] ${i===0?'top-4 left-4':i===1?'top-4 right-4':i===2?'bottom-4 left-4':'bottom-4 right-4'}`}></div>)}
                                <div className="w-full relative py-4 min-w-[750px] overflow-x-auto">
                                    <div className="absolute top-1/2 left-4 right-4 h-3 bg-[#3e2723] rounded-full opacity-60 transform -translate-y-1/2 z-0"></div>
                                    <div className="flex justify-around relative z-10 px-2">
                                        {days.map(day => (
                                            <div key={day.id} className="flex flex-col items-center group relative">
                                                <div className="w-8 h-8 bg-[#3e2723] transform rotate-45 mb-6 shadow-lg border-2 border-[#8d6e63] flex items-center justify-center z-20">
                                                    <div className="w-2 h-2 bg-[#d7ccc8] rounded-full"></div>
                                                </div>
                                                <div onClick={() => setActiveDay(day)} className={`w-32 h-44 bg-[#e8dcc5] rounded-xl border-[5px] border-[#8d6e63] shadow-xl cursor-pointer transition-all duration-300 transform hover:-translate-y-4 hover:rotate-1 hover:shadow-2xl hover:border-[#b91c1c] flex flex-col items-center justify-center relative overflow-hidden ${day.image ? 'bg-opacity-100' : 'bg-opacity-90'}`}>
                                                    <div className="absolute top-0 inset-x-0 bg-[#5d4037] text-[#f5efe6] py-2 text-center font-bold text-lg tracking-widest">{day.label}</div>
                                                    {day.image ? <img src={day.image} alt={day.label} className="w-full h-full object-contain p-3 mt-6" /> : <div className="text-[#a1887f] flex flex-col items-center mt-6 animate-pulse"><Pencil size={32} className="mb-2 opacity-50" /><span className="text-sm font-bold">é»æ“Šåˆ»ç•«</span></div>}
                                                </div>
                                                <div className="mt-4 w-36 text-center h-16 flex items-start justify-center">
                                                    {day.desc ? <div className="bg-white px-3 py-2 rounded-lg text-sm text-[#5d4037] font-bold shadow-md border border-gray-200 w-full line-clamp-2 leading-tight">{day.desc}</div> : <span className="text-[#5d4037]/40 font-bold text-sm">--</span>}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div className="bg-white rounded-3xl shadow-lg p-6 md:p-8">
                            <div className="flex items-center gap-3 mb-6 border-b-2 border-[#f5efe6] pb-4">
                                <span className="bg-[#b91c1c] text-white p-2 rounded-lg"><Save size={24}/></span>
                                <h3 className="text-2xl font-black text-[#5d4037]">æˆ‘çš„ç•«æ›†è§£ç¢¼</h3>
                                <span className="text-sm text-gray-500 ml-auto hidden md:block">ç³»çµ±æœƒè‡ªå‹•ä¿ç•™ä½ çš„ä½œå“åœ¨å¹³æ¿ä¸Šå–”ï¼</span>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {days.filter(d => d.desc || d.image).length === 0 ? <div className="col-span-2 text-center py-12 bg-[#f5efe6] rounded-xl border-2 border-dashed border-[#d7ccc8]"><p className="text-[#8d6e63] text-xl font-bold mb-2">é‚„æ˜¯ä¸€ç‰‡ç©ºç™½çš„æœ¨æ¿...</p></div> : days.filter(d => d.desc || d.image).map(day => (
                                    <div key={day.id} className="flex items-center gap-4 p-4 bg-[#fbf8f3] rounded-xl border border-[#ece0d1] shadow-sm">
                                        <div className="w-20 h-20 bg-[#e8dcc5] rounded-lg border-2 border-[#d7ccc8] flex-shrink-0 overflow-hidden shadow-inner">{day.image ? <img src={day.image} className="w-full h-full object-contain" /> : <span className="flex items-center justify-center h-full text-gray-300">ç„¡</span>}</div>
                                        <div className="flex-1"><div className="flex justify-between items-center mb-1"><span className="font-black text-lg text-[#5d4037]">{day.label}</span><span className="text-xs text-[#b91c1c] bg-[#fee2e2] px-2 py-0.5 rounded-full font-bold">é‡è¦äº‹é …</span></div><p className="text-gray-800 font-medium text-lg leading-snug">{day.desc || "å°šæœªå¡«å¯«æ„ç¾©"}</p></div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </main>

                    <div className="fixed bottom-4 right-4 z-50">
                        <button onClick={() => setShowLogin(true)} className="bg-[#3e2723] text-white p-3 rounded-full shadow-lg hover:bg-[#5d4037] opacity-50 hover:opacity-100 transition">
                            <Lock size={20} />
                        </button>
                    </div>

                    {showLogin && (
                        <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4">
                            <div className="bg-white p-6 rounded-xl shadow-2xl w-80 text-center">
                                <h3 className="text-xl font-bold mb-4 text-[#5d4037]">æ•™å¸«ç™»å…¥</h3>
                                <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full p-2 border rounded mb-4 text-center" placeholder="è¼¸å…¥å¯†ç¢¼ (1234)" />
                                <div className="flex gap-2 justify-center">
                                    <button onClick={() => setShowLogin(false)} className="px-4 py-2 text-gray-600">å–æ¶ˆ</button>
                                    <button onClick={handleTeacherLogin} className="px-4 py-2 bg-[#b91c1c] text-white rounded">ç™»å…¥</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {activeDay && <DrawingCanvas currentDay={activeDay} existingImage={activeDay.image} existingDesc={activeDay.desc} onClose={() => setActiveDay(null)} onSave={handleSaveDay} />}
                    
                    {showReference && (
                        <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4" onClick={() => setShowReference(false)}>
                            <div className="bg-[#fdfbf7] rounded-2xl max-w-4xl w-full max-h-[85vh] overflow-hidden flex flex-col shadow-2xl" onClick={e => e.stopPropagation()}>
                                <div className="bg-[#3e2723] p-4 flex justify-between items-center shrink-0">
                                    <h3 className="text-2xl font-bold text-white flex items-center gap-3"><Info size={28} className="text-[#e8dcc5]" /> å¸ƒè¾²æ—ç•«æ›†ç¬¦è™Ÿåœ–é‘‘</h3>
                                    <button onClick={() => setShowReference(false)} className="text-white hover:bg-white/20 p-2 rounded-full transition"><X size={28}/></button>
                                </div>
                                <div className="p-6 overflow-y-auto custom-scrollbar">
                                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                        {BUNUN_SYMBOLS.map((item, idx) => (
                                            <div key={idx} className="border-2 border-[#d7ccc8] rounded-xl p-4 flex flex-col items-center text-center bg-white hover:border-[#8b5e3c] transition shadow-sm hover:shadow-md group">
                                                <div className="w-20 h-20 mb-3 flex items-center justify-center bg-[#f5efe6] rounded-full group-hover:bg-[#e8dcc5] transition"><SymbolIcon type={item.type} /></div>
                                                <div className="font-black text-lg text-[#5d4037] mb-1">{item.name}</div>
                                                <div className="text-sm text-gray-600 leading-snug">{item.meaning}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div className="p-4 border-t bg-gray-50 text-center shrink-0">
                                    <button onClick={() => setShowReference(false)} className="bg-[#5d4037] text-white px-8 py-3 rounded-xl font-bold text-lg hover:bg-[#3e2723] shadow-lg">æˆ‘å­¸æœƒäº†ï¼Œé–‹å§‹å‰µä½œï¼</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showExport && <ExportModal studentName={studentName} days={days} onClose={() => setShowExport(false)} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>